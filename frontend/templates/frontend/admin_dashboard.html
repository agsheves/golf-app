{% extends 'frontend/base.html' %}

{% block title %}Admin Dashboard - Golf Course Registry{% endblock %}

{% block content %}
<div class="bg-primary text-white py-3 mb-4">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="mb-0">
                <i class="bi bi-speedometer2 me-2"></i>Admin Dashboard
            </h2>
            <div>
                <span class="me-3">Welcome, {{ user.username }}</span>
                <a href="{% url 'admin_logout' %}" class="btn btn-light btn-sm">
                    <i class="bi bi-box-arrow-right me-1"></i>Logout
                </a>
            </div>
        </div>
    </div>
</div>

<div class="container mb-5">
    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    {% endif %}
    
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">
                <i class="bi bi-funnel me-2"></i>Search & Filter
            </h5>
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <input type="text" class="form-control" name="search" placeholder="Search courses..." value="{{ search_query }}">
                </div>
                <div class="col-md-3">
                    <select class="form-select" name="status">
                        <option value="">All Statuses</option>
                        {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if selected_status == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" name="state">
                        <option value="">All States</option>
                        {% for state in states %}
                        <option value="{{ state }}" {% if selected_state == state %}selected{% endif %}>{{ state }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-search me-1"></i>Search
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="mb-3">
        <h4>Manage Courses <span class="badge bg-secondary">{{ courses.count }}</span></h4>
    </div>

    <div class="row g-4">
        {% for course in courses %}
        <div class="col-12">
            <div class="card shadow-sm course-admin-card" data-course-id="{{ course.id }}">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label class="form-label fw-bold small text-muted">Course Name</label>
                                <input type="text" class="form-control editable-field" 
                                       data-field="name" 
                                       value="{{ course.name }}"
                                       data-course-id="{{ course.id }}">
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small text-muted">City</label>
                                    <input type="text" class="form-control editable-field" 
                                           data-field="city" 
                                           value="{{ course.city }}"
                                           data-course-id="{{ course.id }}">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold small text-muted">State</label>
                                    <input type="text" class="form-control editable-field" 
                                           data-field="state" 
                                           value="{{ course.state }}"
                                           data-course-id="{{ course.id }}">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold small text-muted">Zip</label>
                                    <input type="text" class="form-control editable-field" 
                                           data-field="zip_code" 
                                           value="{{ course.zip_code }}"
                                           data-course-id="{{ course.id }}">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label fw-bold small text-muted">Address</label>
                                <textarea class="form-control editable-field" 
                                          data-field="address" 
                                          rows="2"
                                          data-course-id="{{ course.id }}">{{ course.address }}</textarea>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small text-muted">Phone</label>
                                    <input type="text" class="form-control editable-field" 
                                           data-field="phone_number" 
                                           value="{{ course.phone_number }}"
                                           data-course-id="{{ course.id }}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small text-muted">Website</label>
                                    <input type="url" class="form-control editable-field" 
                                           data-field="website" 
                                           value="{{ course.website }}"
                                           data-course-id="{{ course.id }}">
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold small text-muted">Green Fee</label>
                                    <input type="text" class="form-control editable-field" 
                                           data-field="cost" 
                                           value="{{ course.cost }}"
                                           data-course-id="{{ course.id }}">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold small text-muted">Cart Rental</label>
                                    <input type="text" class="form-control editable-field" 
                                           data-field="rent_cart_cost" 
                                           value="{{ course.rent_cart_cost }}"
                                           data-course-id="{{ course.id }}">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold small text-muted">Google Rating</label>
                                    <input type="text" class="form-control editable-field" 
                                           data-field="rating_google" 
                                           value="{{ course.rating_google }}"
                                           data-course-id="{{ course.id }}">
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="text-center mb-3">
                                <button class="btn btn-lg w-100 approval-toggle-btn 
                                       {% if course.status == 'approved' %}btn-success{% else %}btn-outline-secondary{% endif %}"
                                        data-course-id="{{ course.id }}"
                                        data-status="{{ course.status }}">
                                    <i class="bi {% if course.status == 'approved' %}bi-check-circle-fill{% else %}bi-circle{% endif %} me-2"></i>
                                    <span class="status-text">{{ course.get_status_display }}</span>
                                </button>
                            </div>
                            
                            <div class="badge bg-info text-dark w-100 mb-2">
                                ID: {{ course.id }}
                            </div>
                            
                            {% if course.reviewed_by %}
                            <div class="small text-muted mb-2">
                                <i class="bi bi-person me-1"></i>Reviewed by: {{ course.reviewed_by.username }}
                            </div>
                            {% endif %}
                            
                            {% if course.reviewed_at %}
                            <div class="small text-muted mb-3">
                                <i class="bi bi-clock me-1"></i>{{ course.reviewed_at|date:"M d, Y H:i" }}
                            </div>
                            {% endif %}
                            
                            <div class="mb-3">
                                <label class="form-label fw-bold small text-muted">
                                    <i class="bi bi-image me-1"></i>Course Image
                                </label>
                                <div class="mb-2">
                                    {% if course.thumbnail %}
                                    <img src="{{ course.thumbnail }}" class="img-fluid rounded" alt="{{ course.name }}" style="max-height: 150px; width: 100%; object-fit: cover;">
                                    {% else %}
                                    <div class="bg-success text-white rounded d-flex align-items-center justify-content-center" style="height: 150px;">
                                        <h1 class="mb-0">⛳</h1>
                                    </div>
                                    {% endif %}
                                </div>
                                <input type="url" class="form-control editable-field" 
                                       data-field="thumbnail" 
                                       value="{{ course.thumbnail }}"
                                       placeholder="https://example.com/image.jpg"
                                       data-course-id="{{ course.id }}">
                                <small class="text-muted">Enter image URL</small>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label fw-bold small text-muted">Notes</label>
                                <textarea class="form-control editable-field" 
                                          data-field="moderation_notes" 
                                          rows="3"
                                          placeholder="Admin notes..."
                                          data-course-id="{{ course.id }}">{{ course.moderation_notes }}</textarea>
                            </div>
                            
                            <a href="{% url 'course_detail' course.id %}" target="_blank" class="btn btn-sm btn-outline-primary w-100">
                                <i class="bi bi-eye me-1"></i>View Public Page
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>No courses found.
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = '{{ csrf_token }}';
    
    document.querySelectorAll('.approval-toggle-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const courseId = this.dataset.courseId;
            const statusText = this.querySelector('.status-text');
            const icon = this.querySelector('i');
            
            fetch(`/admin/course/${courseId}/toggle-approval/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusText.textContent = data.status_display;
                    this.dataset.status = data.status;
                    
                    if (data.status === 'approved') {
                        this.classList.remove('btn-outline-secondary');
                        this.classList.add('btn-success');
                        icon.classList.remove('bi-circle');
                        icon.classList.add('bi-check-circle-fill');
                    } else {
                        this.classList.remove('btn-success');
                        this.classList.add('btn-outline-secondary');
                        icon.classList.remove('bi-check-circle-fill');
                        icon.classList.add('bi-circle');
                    }
                }
            });
        });
    });
    
    let updateTimeout;
    document.querySelectorAll('.editable-field').forEach(field => {
        field.addEventListener('input', function() {
            clearTimeout(updateTimeout);
            const courseId = this.dataset.courseId;
            const fieldName = this.dataset.field;
            const value = this.value;
            
            if (fieldName === 'thumbnail' && value) {
                const card = this.closest('.course-admin-card');
                const img = card.querySelector('img.img-fluid');
                if (img) {
                    img.src = value;
                }
            }
            
            updateTimeout = setTimeout(() => {
                fetch(`/admin/course/${courseId}/update-field/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `field=${fieldName}&value=${encodeURIComponent(value)}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        this.classList.add('border-success');
                        setTimeout(() => {
                            this.classList.remove('border-success');
                        }, 1000);
                    }
                });
            }, 800);
        });
    });
});
</script>
{% endblock %}
